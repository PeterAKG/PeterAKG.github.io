<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>File Rename Tracker</title>
</head>
<body>
<h1>File Rename Tracker</h1>
<p>This tool only works in Chromium-based browsers (e.g., Chrome). Please use a compatible browser.</p>

<button id="select-directory-btn">Select Directory</button>
<button id="stop-tracking-btn" disabled>Stop Tracking & Download</button>

<script>
let directoryHandle;
let initialFiles = [];
let startTime = new Date(); // Record the time the user first loaded the page

// Prompt user to select a directory and store a handle
async function selectDirectory() {
  try {
    directoryHandle = await window.showDirectoryPicker();
    await takeInitialSnapshot();
    document.getElementById('stop-tracking-btn').disabled = false;
  } catch (err) {
    console.error('Directory selection cancelled or failed', err);
  }
}

// Take initial snapshot of filenames
async function takeInitialSnapshot() {
  initialFiles = await listFiles(directoryHandle);
  console.log('Initial files:', initialFiles);
}

// List files in the selected directory (non-recursive)
async function listFiles(dirHandle) {
  const files = [];
  for await (const entry of dirHandle.values()) {
    if (entry.kind === 'file') {
      files.push(entry.name);
    }
  }
  return files;
}

// Count how many files were renamed by comparing initial and final snapshots
function countRenames(initial, final) {
  const initialSet = new Set(initial);
  const finalSet = new Set(final);

  let removedCount = 0;
  for (const f of initialSet) {
    if (!finalSet.has(f)) {
      removedCount++;
    }
  }

  let addedCount = 0;
  for (const f of finalSet) {
    if (!initialSet.has(f)) {
      addedCount++;
    }
  }

  // Assuming purely renames:
  return Math.min(removedCount, addedCount);
}

// Compare snapshots, record times, and download summary
async function stopTrackingAndDownload() {
  if (!directoryHandle) {
    alert('Please select a directory first.');
    return;
  }

  const finalFiles = await listFiles(directoryHandle);
  const renamedCount = countRenames(initialFiles, finalFiles);

  const endTime = new Date(); // Record when "Stop Tracking" was clicked
  const sessionDurationMs = endTime - startTime; // Duration in milliseconds

  // Convert duration to a human-readable format (e.g., total seconds)
  const sessionDurationSec = Math.floor(sessionDurationMs / 1000);
  const sessionDurationMin = Math.floor(sessionDurationSec / 60);
  const sessionDurationRemainingSec = sessionDurationSec % 60;

  const formattedStartTime = startTime.toLocaleString();
  const formattedEndTime = endTime.toLocaleString();
  const formattedSessionDuration = `${sessionDurationMin} min ${sessionDurationRemainingSec} sec`;

  const summary = 
`Number of files renamed: ${renamedCount}
Start time: ${formattedStartTime}
End time: ${formattedEndTime}
Session duration: ${formattedSessionDuration}
`;

  const blob = new Blob([summary], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = 'rename_summary.txt';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);

  URL.revokeObjectURL(url);
}

// Event Listeners
document.getElementById('select-directory-btn').addEventListener('click', selectDirectory);
document.getElementById('stop-tracking-btn').addEventListener('click', stopTrackingAndDownload);
</script>
</body>
</html>
